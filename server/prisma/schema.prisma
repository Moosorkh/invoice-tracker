// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                String         @id @default(uuid())
  name              String
  slug              String         @unique // URL-safe tenant identifier (e.g., "acme-loans")
  plan              String         @default("free") // free, starter, professional, enterprise
  status            String         @default("active") // active, suspended, canceled
  billingCustomerId String?        // Stripe customer ID
  currency          String         @default("USD")
  
  // Usage limits (enforced by plan)
  maxUsers          Int            @default(3)
  maxClients        Int            @default(10)
  maxInvoices       Int            @default(50)
  maxLoans          Int            @default(10)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  users             UserTenant[]
  clients           Client[]
  invoices          Invoice[]
  loans             Loan[]
  subscriptions     Subscription[]
  clientUsers       ClientUser[]   // Portal users for end-customers

  @@index([slug])
}

model User {
  id        String       @id @default(uuid())
  email     String       @unique
  password  String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  tenants   UserTenant[]
  invoices  Invoice[]
  loans     Loan[]
}

model UserTenant {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  role      String   @default("member") // owner, admin, accountant, viewer
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}
model Client {
  id          String       @id @default(uuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic info
  name        String
  email       String
  phone       String?
  
  // Enhanced borrower fields for loan servicing
  type        String       @default("individual") // individual, business
  taxId       String?      // SSN/EIN - encrypt in production
  dateOfBirth DateTime?
  
  // Business-specific
  businessName    String?
  businessType    String?  // LLC, Corporation, etc.
  
  // Contact details
  mailingAddress  String?
  physicalAddress String?
  city            String?
  state           String?
  zipCode         String?
  country         String?   @default("US")
  
  // Status & notes
  status      String       @default("active") // active, inactive, suspended
  notes       String?
  
  // Relations
  invoices    Invoice[]
  loans       Loan[]
  addresses   ClientAddress[]
  contacts    ClientContact[]
  documents   ClientDocument[]
  portalUsers ClientUser[] // Portal access for this client
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String
  tenantId      String
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Decimal       @db.Decimal(19, 4)
  status        String
  dueDate       DateTime?
  description   String?
  payments      Payment[]
  items         InvoiceItem[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([clientId])
  @@index([userId])
  @@index([status])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal  @db.Decimal(19, 4)
  unitPrice   Decimal  @db.Decimal(19, 4)
  amount      Decimal  @db.Decimal(19, 4)
  createdAt   DateTime @default(now())

  @@index([invoiceId])
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  loanId    String?
  loan      Loan?    @relation(fields: [loanId], references: [id], onDelete: Cascade)
  amount    Decimal  @db.Decimal(19, 4)
  method    String
  notes     String?
  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([loanId])
}

model Loan {
  id               String                 @id @default(uuid())
  loanNumber       String
  tenantId         String
  tenant           Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId         String
  client           Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId           String
  user             User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Product classification (determines calculation behavior)
  productCategory  String                 @default("personal") // mortgage, heloc, auto, personal, business
  accrualMethod    String                 @default("amortizing") // amortizing, simple_daily, precomputed
  paymentStructure String                 @default("level") // level, interest_only, balloon
  dayCountConvention String               @default("actual_365") // actual_365, actual_360, thirty_360
  
  // Loan terms
  principal        Decimal                @db.Decimal(19, 4)
  interestRate     Decimal                @db.Decimal(5, 4) // Annual percentage rate (supports 12.5000%)
  rateType         String                 @default("fixed") // fixed, variable
  termMonths       Int
  paymentFrequency String                 @default("monthly") // monthly, biweekly, weekly
  amortizationType String                 @default("amortizing") // amortizing, interest_only, balloon
  
  // Special structures
  interestOnlyMonths Int?                 // For interest-only periods
  balloonAmount     Decimal?              @db.Decimal(19, 4) // For balloon loans
  
  // Important dates
  startDate        DateTime
  firstDueDate     DateTime
  maturityDate     DateTime
  nextDueDate      DateTime?
  activatedAt      DateTime?  // When loan was boarded/activated
  
  // Lifecycle states
  status           String                 @default("draft") // draft, approved, active, paid_off, charged_off, in_default
  substatus        String?                // current, delinquent_30, delinquent_60, delinquent_90, in_collections
  
  // Running balances (updated by ledger events)
  currentPrincipal Decimal                @db.Decimal(19, 4) @default(0)
  currentInterest  Decimal                @db.Decimal(19, 4) @default(0)
  currentFees      Decimal                @db.Decimal(19, 4) @default(0)
  totalPaid        Decimal                @db.Decimal(19, 4) @default(0)
  
  // Configuration
  graceDays        Int                    @default(10)
  lateFeeAmount    Decimal?               @db.Decimal(19, 4)
  lateFeePercent   Decimal?               @db.Decimal(5, 2)
  
  // Metadata
  description      String?
  internalNotes    String?
  
  // Relations
  payments         Payment[]
  schedule         LoanPaymentSchedule[]
  events           LoanEvent[]
  documents        LoanDocument[]
  
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  @@unique([tenantId, loanNumber])
  @@index([tenantId])
  @@index([clientId])
  @@index([userId])
  @@index([status])
  @@index([substatus])
}

model LoanPaymentSchedule {
  id             String   @id @default(uuid())
  loanId         String
  loan           Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  dueDate        DateTime
  principalDue   Decimal  @db.Decimal(19, 4)
  interestDue    Decimal  @db.Decimal(19, 4)
  totalDue       Decimal  @db.Decimal(19, 4)
  paidPrincipal  Decimal  @db.Decimal(19, 4) @default(0)
  paidInterest   Decimal  @db.Decimal(19, 4) @default(0)
  status         String   @default("pending") // pending, paid, partial, overdue
  createdAt      DateTime @default(now())

  @@index([loanId])
  @@index([dueDate])
  @@index([status])
}

model Subscription {
  id                   String    @id @default(uuid())
  tenantId             String
  tenant               Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stripeSubscriptionId String?   @unique // Stripe subscription ID
  stripePriceId        String? // Stripe price ID
  stripeProductId      String? // Stripe product ID
  plan                 String // free, starter, professional, enterprise
  status               String    @default("active") // active, trialing, past_due, canceled, incomplete
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([tenantId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

// Client portal user - allows end-customers to view their data
model ClientUser {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  email     String
  name      String?
  status    String   @default("active") // active, suspended, invited
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([clientId])
  @@index([email])
}

// Magic link / OTP tokens for client portal authentication
model PortalAuthToken {
  id        String   @id @default(uuid())
  email     String
  tenantId  String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email, tenantId])
  @@index([expiresAt])
}

// ========================================
// LOAN SERVICING MODELS
// ========================================

// Client addresses (for loan documentation & mailing)
model ClientAddress {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  type        String   // mailing, physical, business
  street1     String
  street2     String?
  city        String
  state       String
  zipCode     String
  country     String   @default("US")
  
  isPrimary   Boolean  @default(false)
  effectiveFrom DateTime @default(now())
  effectiveTo   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([type])
}

// Client contacts (for business customers)
model ClientContact {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  name        String
  role        String?  // CFO, Accountant, Authorized Signer
  email       String
  phone       String?
  isPrimary   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
}

// Client documents (ID, tax forms, signed agreements)
model ClientDocument {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  type        String   // drivers_license, passport, tax_form, credit_report, signed_agreement
  fileName    String
  fileUrl     String   // S3/storage URL
  fileSize    Int?
  mimeType    String?
  
  uploadedBy  String?  // User ID
  notes       String?
  
  createdAt   DateTime @default(now())

  @@index([clientId])
  @@index([type])
}

// Loan documents (promissory notes, disclosures)
model LoanDocument {
  id          String   @id @default(uuid())
  loanId      String
  loan        Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  type        String   // promissory_note, truth_in_lending, payment_schedule, amendment
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  
  uploadedBy  String?
  notes       String?
  signedAt    DateTime?
  
  createdAt   DateTime @default(now())

  @@index([loanId])
  @@index([type])
}

// Loan event ledger (append-only, single source of truth)
model LoanEvent {
  id          String   @id @default(uuid())
  loanId      String
  loan        Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  type        String   // disbursement, payment_posted, fee_assessed, interest_accrued, adjustment, reversal, status_change
  
  // Amounts (what changed)
  principalAmount  Decimal? @db.Decimal(19, 4)
  interestAmount   Decimal? @db.Decimal(19, 4)
  feeAmount        Decimal? @db.Decimal(19, 4)
  
  // Balances after this event
  principalBalance Decimal  @db.Decimal(19, 4)
  interestBalance  Decimal  @db.Decimal(19, 4)
  feeBalance       Decimal  @db.Decimal(19, 4)
  
  // Metadata
  effectiveDate    DateTime @default(now())
  description      String?
  metadata         Json?    // Store additional context
  
  // Audit
  createdBy   String?  // User ID
  reversedBy  String?  // If this event was reversed, which event did it
  reversalOf  String?  // If this is a reversal, which event does it reverse
  
  createdAt   DateTime @default(now())

  @@index([loanId])
  @@index([type])
  @@index([effectiveDate])
  @@index([createdAt])
}

